<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html" />
<link rel="import" href="../iron-icons/iron-icons.html" />
<link rel="import" href="../t-shared-lib/t-fare-behavior.html">
<link rel="import" href="../t-image/t-image.html">
<link rel="import" href="../t-text-container/travel-element-styles.html">
<!--
`t-hotel-itinerary-item` is a Hotel result itinerary component. 
This component is ideally used in result page to repeat each Hotel item. 

Example:
    <t-hotel-itinerary-item show-debug-info></t-hotel-itinerary-item>
-->
<dom-module id="t-hotel-itinerary-item">
    <template>
        <style include="iron-flex"></style>
        <style include="iron-flex-alignment"></style>
        <style include="travel-element-styles">
        :host{
            display: block;
            border-bottom: 1px solid var(--grey-two,#eeeeee);
        }
        .imageArea {
            width: 70px;
            height: 70px;
            position: relative;
        }
        
        .imageArea t-image {
            width: 100%;
            height: 100%;
        }
        
        .badgeText {
            color: #fff;
            padding: 2px;
            font-size: 10px;
            line-height: 1;
            position: absolute;
            left: 0;
            top: 0;
        }
        
        .badge::before {
            content: "";
            position: absolute;
            left: 0;
            width: 0;
            height: 0;
            top: 0;
            border-top: 24px solid var(--badge-bg, #f18722);
            border-right: 24px solid transparent;
        }
        iron-icon{
            width: 10px;
            height: 10px;
            color: #777777;
        }
        .text-capital{
            text-transform: capitalize;
        }
        .hotel-name{
            line-height: 1.4;
        }
        .discount{
            text-decoration: line-through;
            margin-left: 3px;
            display: block;
        }
        .pricing{
            width: 80px;
            max-width: 100px;
            line-height: 1;
        }
        .right-container{
            margin-left: 5px;
            overflow-x: hidden;
            padding-bottom: 2px;
        }
        .address {
            line-height: 1.2;
            padding-top: 2px;
        }
        </style>
            <div class="layout horizontal section primary-text">
                <div class="imageArea">
                    <t-image src="{{itinerary.heroImageUrl}}"></t-image>
                    <template is="dom-if" if="{{itinerary.deal}}">
                        <!-- <span style="color:red"> {{itinerary.deal.description}}</span> -->
                        <span class="badge"></span>
                        <span class="badgeText">%</span>
                    </template>
                </div>
                <div class="flex layout vertical right-container">
                    <div class="font-16 hotel-name text-capital ellipsis primary-light-text">{{_getLowerCase(itinerary.name)}}</div>
                    <div class="layout horizontal flex">
                        <div class="layout vertical flex">
                            <span class="font-12 secondary-text address ellipsis-2">[[itinerary.address]]</span>
                            <span class="flex"></span>
                            <div class="layout horizontal">
                                <template is="dom-repeat" items="{{_numberToArray(itinerary.rating)}}">
                                    <iron-icon icon="star"></iron-icon>
                                </template>
                            </div>
                        </div>
                        <div class="pricing font-12 layout vertical text-right">
                            <span class="flex"></span>
                            <div class="layout horizontal secondary-text end-justified margin bottom">
                                <span>{{_currency}}</span>
                                <template is="dom-if" if="[[_isDiscountApplicable(_strikeOffPrice, _displayPrice)]]">
                                    <span class="discount">{{_getDisplayFare(_strikeOffPrice.money.amount, itinerary.stayDuration.start.date, itinerary.stayDuration.end.date)}}</span>
                                </template>
                            </div>
                            <div class="primary-text font-16 font-semi">{{_getDisplayFare(_displayPrice.money.amount, itinerary.stayDuration.start.date, itinerary.stayDuration.end.date)}}</div>
                            <div class="secondary-text">avg/night</div>
                        </div>
                    </div>
                    <template is="dom-if" if="{{showDebugInfo}}">
                        <div>
                            isPostPaid - {{itinerary.isPostPaid}}
                            <br/> supplier source - {{itinerary.source.name}}
                        </div>
                    </template>
                </div>
            </div>
    </template>
</dom-module>
<script>
Polymer({

    is: 't-hotel-itinerary-item',

    properties: {

        /*Itinerary is the API json object to pass in the component which will populate the data*/
        itinerary: {
            type: Object,
            value: function() {
                return {};
            }
        },

        /*Set this to true while using Debug Info*/
        showDebugInfo: {
            type: Boolean,
            value: false
        }

    },

    observers: ['_fareComponentsChanged(itinerary.fare.components)'],

    behaviors: [TravelNxt.Behaviors.FareBehavior],

    _fareComponentsChanged: function(components) {
        this._components = components;
        //this.notifyPath('_components', components);
    },

    _getLowerCase:function(text){
        text = text || "";
        return text.toLowerCase();
    },

    _numberToArray: function(number) {
        var arr = [];
        for (var i = 0; i < number; i++) {
            arr.push(i);
        };
        return arr;
    },

    _getDisplayFare: function(amount, checkIn, checkOut) {
        if (amount) {
            return parseInt(amount / this._dateDiff(checkIn, checkOut));
        }
        return null;
    },

    _isDiscountApplicable: function (strikeOffPrice, displayPrice) {
        return strikeOffPrice.money.amount > displayPrice.money.amount;
    },

    _dateDiff: function(fromDate, toDate) {
        if (!fromDate || !toDate)
            return 0;
        if (typeof fromDate == 'string') {
            fromDate = new Date(fromDate);
        }
        if (typeof toDate == 'string') {
            toDate = new Date(toDate);
        }
        var diff = toDate - fromDate;
        var divideBy = (24 * 60 * 60 * 1000);

        return Math.floor(diff / divideBy);
    }
})
</script>
